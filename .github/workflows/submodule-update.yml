name: Update submodule
run-name: Update "telegram-bot-api" submodule

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"       # Runs at 0:0 AM UTC Everyday


jobs:

  checks:
    name: Checks
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.update_status.outputs.current_version }}
      updated_version: ${{ steps.update_status.outputs.updated_version }}
      updated: ${{ steps.update_status.outputs.updated }}
    steps:
      
      - name: Checkout current repository
        uses: actions/checkout@main
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Checkout submodule updates
        id: update_status
        run: |
          # Get current version 
          current_version=$(cat telegram-bot-api/CMakeLists.txt | grep TelegramBotApi | cut -d " " -f3)

          # Checkout updates
          returnedValue=$(git submodule update --remote)

          # Get new version
          updated_version=$(cat telegram-bot-api/CMakeLists.txt | grep TelegramBotApi | cut -d " " -f3)

          # Checks if submodule was updated
          updated=$([ -n "$returnedValue" ] && echo "true" || echo "false")

          # Set outputs & summary
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "updated_version=$updated_version" >> $GITHUB_OUTPUT
          echo "updated=$updated" >> $GITHUB_OUTPUT
          echo "#### 👉 Submodule Update found:   $updated" >> $GITHUB_STEP_SUMMARY



  commit:
    name: Commit updated submodule
    runs-on: ubuntu-latest
    needs: checks
    if: needs.checks.outputs.updated == "true"
    steps:
      
      - name: Checkout current repository
        uses: actions/checkout@main
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Commit submodule updates to main-branch
        run: |
          # Versions
          current_version=${{ needs.checks.outputs.current_version }}
          updated_version=${{ needs.checks.outputs.updated_version }}

          # Commit changes
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add .
          git commit -am "_deploy_: Updated telegram-bot-api submodule from v${current_version} to v${updated_version}"
          git push origin main
      
      - name: Summary
        run: |
          echo "#### ✔️ Submodule Updates commited from v${current_version} to v${updated_version} to main branch" >> $GITHUB_STEP_SUMMARY
